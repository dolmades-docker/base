#!/bin/bash
#
# Author: Stefan Kombrink <stefan.kombrink@gmail.com>
#
# Icons are licensed under https://creativecommons.org/licenses/by-nd/3.0/
# and are available under https://icons8.com
#

# Metadata resides there
metadir="/.dolmades"

# scan just c:
# else we will scan bind mounts if any are configured
# and we consider this a security leak
scandir='/wineprefix/dosdevices/c:/'
dolmadeName="$(cat $metadir/dolmadename | tr -cd '[:print:]')"
separator='|'
dolmadeIcon="$metadir/icon.png"
lnkTargets=$(find $scandir -name '*.lnk' -exec winepath -w  {} \; | sed 's/\\/\\\\/g' | tr -s '\n' "$separator")

function createIcons() {
cat << EOF > $metadir/cancel.svg
<?xml version="1.0"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16px" height="16px">
    <path d="M12,2C6.47,2,2,6.47,2,12c0,5.53,4.47,10,10,10s10-4.47,10-10C22,6.47,17.53,2,12,2z M16.707,15.293 c0.391,0.391,0.391,1.023,0,1.414C16.512,16.902,16.256,17,16,17s-0.512-0.098-0.707-0.293L12,13.414l-3.293,3.293 C8.512,16.902,8.256,17,8,17s-0.512-0.098-0.707-0.293c-0.391-0.391-0.391-1.023,0-1.414L10.586,12L7.293,8.707 c-0.391-0.391-0.391-1.023,0-1.414s1.023-0.391,1.414,0L12,10.586l3.293-3.293c0.391-0.391,1.023-0.391,1.414,0 s0.391,1.023,0,1.414L13.414,12L16.707,15.293z"/>
</svg>
EOF
}

cat << EOF > $metadir/ok.svg
<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 26 26" version="1.1" width="26px" height="26px">
<g id="surface1">
<path style=" " d="M 13 0.1875 C 5.925781 0.1875 0.1875 5.925781 0.1875 13 C 0.1875 20.074219 5.925781 25.8125 13 25.8125 C 20.074219 25.8125 25.8125 20.074219 25.8125 13 C 25.8125 5.925781 20.074219 0.1875 13 0.1875 Z M 19.734375 9.035156 L 12.863281 19.167969 C 12.660156 19.46875 12.335938 19.671875 12.015625 19.671875 C 11.695313 19.671875 11.34375 19.496094 11.117188 19.273438 L 7.085938 15.238281 C 6.8125 14.964844 6.8125 14.515625 7.085938 14.242188 L 8.082031 13.246094 C 8.355469 12.972656 8.804688 12.972656 9.074219 13.246094 L 11.699219 15.867188 L 17.402344 7.453125 C 17.621094 7.132813 18.0625 7.050781 18.382813 7.265625 L 19.550781 8.058594 C 19.867188 8.273438 19.953125 8.714844 19.734375 9.035156 Z "/>
</g>
</svg>
EOF


cat << EOF | base64 --decode > $metadir/run.svg
PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+Cjxz
dmcKICAgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIgogICB4bWxu
czpjYz0iaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbnMjIgogICB4bWxuczpyZGY9Imh0dHA6
Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiCiAgIHhtbG5zOnN2Zz0iaHR0
cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAw
L3N2ZyIKICAgdmlld0JveD0iMCAwIDk5IDk5IgogICBoZWlnaHQ9Ijk5IgogICB3aWR0aD0iOTki
CiAgIGlkPSJzdmcyIgogICB2ZXJzaW9uPSIxLjEiPgogIDxtZXRhZGF0YQogICAgIGlkPSJtZXRh
ZGF0YTgiPgogICAgPHJkZjpSREY+CiAgICAgIDxjYzpXb3JrCiAgICAgICAgIHJkZjphYm91dD0i
Ij4KICAgICAgICA8ZGM6Zm9ybWF0PmltYWdlL3N2Zyt4bWw8L2RjOmZvcm1hdD4KICAgICAgICA8
ZGM6dHlwZQogICAgICAgICAgIHJkZjpyZXNvdXJjZT0iaHR0cDovL3B1cmwub3JnL2RjL2RjbWl0
eXBlL1N0aWxsSW1hZ2UiIC8+CiAgICAgICAgPGRjOnRpdGxlPjwvZGM6dGl0bGU+CiAgICAgIDwv
Y2M6V29yaz4KICAgIDwvcmRmOlJERj4KICA8L21ldGFkYXRhPgogIDxkZWZzCiAgICAgaWQ9ImRl
ZnM2IiAvPgogIDxwYXRoCiAgICAgaWQ9InBhdGgxMiIKICAgICBkPSJtIDI5LjgzNjcxMSw4OS42
Mzg5MzMgYyAtMS4yNzUzODMsLTIuNzk5MTYgLTAuMjE2MDMzLC00LjkwMTU4IDUuODU2Njg4LC0x
MS42MjMzNTcgMy41MzQzMjIsLTMuOTEyMDcyIDMuNTUwMTE3LC0zLjkxNzU3MiAxMS4xNzI5NjMs
LTMuODkwODM5IEwgNTQuNSw3NC4xNTE1MDcgNDUuMzAzMDU4LDgzLjEyNDczMSBjIC0xMC4wNDY1
OTgsOS44MDIyMiAtMTMuMzM2ODE1LDExLjE4ODAxIC0xNS40NjYzNDcsNi41MTQyIHogTSAyOC41
NzE0MjksNjguNTI2NTM3IGMgLTEuOTQ0Mzc4LC0xLjk0NDM3OCAtMS45ODM5MDYsLTMuNDgxNDQ3
IC0wLjE1Mzk3NCwtNS45ODc0NDEgMS4yMzM5NDIsLTEuNjg5ODE4IDIuOTE3MDEyLC0xLjk4NDYz
OCAxMywtMi4yNzcxODMgNi4zNzA0LC0wLjE4NDgyOSAxMS41NzgxNjMsLTAuNjM0ODI5IDExLjU3
MjgwNywtMSBDIDUyLjk4NDg2Miw1OC44OTY3NDIgNDkuODM5Mjg5LDU0LjA5Nzk2NiA0Niw0OC41
OTc5NjYgMzUuOTI5MTE5LDM0LjE3MDg1NSAzNi4yMzkzMzksMzIuMjY3MDAzIDUwLjI0Njg1NCwy
Mi41MzQ1NyBjIDQuNTM5MjMsLTMuMTUzODYxIDguNDc4MTQ2LC01LjkzNjIwOSA4Ljc1MzE0MSwt
Ni4xODI5OTUgMC4yNzUsLTAuMjQ2Nzg2IC0xLjA2NzgzOCwtMS43NjMwMjIgLTIuOTg0MDkyLC0z
LjM2OTQxNCBDIDUyLjU4NTUzMSwxMC4xMDY0ODYgNTIuMzk4NTI0LDEwLjA3MTUxIDQzLjg4ODI1
MSwxMC43MTM5NTEgMjkuOTA1MjM5LDExLjc2OTUyOSAyNC4xNDM5Niw5LjUwOTU2MSAyOC44NDE4
MTMsNC44MTE3MDkgMzAuMzMwODA1LDMuMzIyNzE2IDMzLjU3ODQ5NywyLjU2NzU3NiA0My4zMTY5
NjYsMS40NDYwMDMgTCA1NS44NzI0MTUsMCBsIDguNTQ5OTcsNS42ODk4ODggYyAxMi42NTk3OSw4
LjQyNDkyNSAxNy45NTA4MiwxNy44NDk3MTkgMTIuMzI3NjEsMjEuOTU4OTA4IC0xLjIzNzUsMC45
MDQzMDkgLTYuNDIxNzUsNC4zMDY5MTggLTExLjUyMDU3LDcuNTYxMzUzIGwgLTkuMjcwNTc2LDUu
OTE3MTU0IDQuODU2MTI2LDcuMjM1MzMyIGMgNi4xNDM2NCw5LjE1MzY2IDEwLjE4NTAyLDE2LjA5
ODI5NyAxMC4xODUwMiwxNy41MDE3NiAwLDAuNTk5ODkzIC0wLjcwNzE0LDEuNzk3ODU3IC0xLjU3
MTQyLDIuNjYyMTQyIC0yLjMzNzYyLDIuMzM3NjIxIC0zOC41MTk1MjYsMi4zMzc2MjEgLTQwLjg1
NzE0NiwwIHogTSAwLDQ4LjU5Nzk2NiBjIDAsLTEuMjgzMzMzIDIuODg4ODg5LC0xLjUgMjAsLTEu
NSAxNy4xMTExMTEsMCAyMCwwLjIxNjY2NyAyMCwxLjUgMCwxLjI4MzMzMyAtMi44ODg4ODksMS41
IC0yMCwxLjUgLTE3LjExMTExMSwwIC0yMCwtMC4yMTY2NjcgLTIwLC0xLjUgeiBtIDcxLjc0OTk5
NSwtNi43NSBjIC0yLjczMDY3LC0yLjczMDY3NyAtMi4xMTYzNCwtNC40MDE4NjUgMi44ODIzOSwt
Ny44NDEwODYgNC4wOTIyNSwtMi44MTU1MzcgNC43MzkzNSwtMi45OTYwNDEgNS41NDk2OSwtMS41
NDgwNDEgMC41OTAwNywxLjA1NDM5MSAyLjIzNzM0LDEuNjQzMDUzIDQuNjE3NjEsMS42NTAxMzMg
MTAuMDk0NDMsMC4wMzAwMiAxNC42NzI5MjcsMi41OTI4MTQgMTEuNzU2ODMsNi41ODA4MTkgLTEu
MTQxMjYsMS41NjA3NjEgLTMuMTUwMjcsMS45NTM2NjIgLTEyLjIxMTI1LDIuMzg4MTQgLTkuNDM0
NTksMC40NTIzOTIgLTExLjA3Mjg5LDAuMjkyNDA3IC0xMi41OTUyNywtMS4yMjk5NjUgeiBNIDEu
MjUsNDAuNDQ5IEMgMC41NjI0OTk5OSw0MC4xNjQyNjUgMCwzOS4yOTM3OTkgMCwzOC41MTQ2MzMg
YyAwLC0xLjE2MzQ2NCAyLjg3MjgwOSwtMS40MTY2NjcgMTYuMDczMzI0LC0xLjQxNjY2NyAxNC43
NjkyMTQsMCAxNi4wNDYwNzMsMC4xNDE5ODYgMTUuNzM3NDQ3LDEuNzUgQyAzMS41MTEzMDIsNDAu
NDA4Mjc1IDI5LjkwNDUzLDQwLjYxNzk1IDE2Ljk4NzQ0Nyw0MC43ODIzMzQgOS4wMTkzNTEsNDAu
ODgzNzM2IDEuOTM3NSw0MC43MzM3MzQgMS4yNSw0MC40NDkgWiBNIDAuNTE1ODQ3OTksMzAuMTIz
NjA5IEMgLTEuMDMyMTc3LDI3LjYxODg1MSAxLjc0MjM4NiwyNy4wOTc5NjYgMTYuNjMyMzQxLDI3
LjA5Nzk2NiBjIDE0LjIzNjg0LDAgMTUuNDg2NjQ2LDAuMTQ0MDk3IDE1LjE3ODM3MiwxLjc1IC0w
LjI5OTQ4OSwxLjU2MDEzNCAtMS45ODA5ODgsMS43Nzk5MDYgLTE1LjQ5ODQ1OSwyLjAyNTY0MyAt
OS41ODEwNDgsMC4xNzQxNzYgLTE1LjM5NTg2MjAxLC0wLjEwMTkwNyAtMTUuNzk2NDA2MDEsLTAu
NzUgeiBNIDAuNDU4ODA0OTksMjAuMDMxMzExIEMgLTEuMDk4NTk4LDE3LjUxMTM4IDIuMzg4MDk5
LDE3LjA2NDY1IDIxLjU3MTczNSwxNy4zMjYyMzEgMzguNDk4MzExLDE3LjU1NzAzNiA0MS41LDE3
LjgyMzkwMyA0MS41LDE5LjA5Nzk2NiBjIDAsMS4yNzQ4MzkgLTMuMDI4OTE1LDEuNTQwNjAxIC0y
MC4xNzgzMjcsMS43NzA0NzcgQyA3LjM3MTA4NCwyMS4wNTU0NDIgMC45MzIwNzE5OSwyMC43OTcw
NzMgMC40NTg4MDQ5OSwyMC4wMzEzMTEgWiBNIDg0Ljc3NTE0NSwxOC41MzkxNjQgYyAtNS43ODI1
MywtMy4xMzgwNjMgLTYuNjIyNTUsLTEwLjc0NzYzNSAtMS43MjY4NywtMTUuNjQzMzE1IDIuNzAy
MTUsLTIuNzAyMTU3IDMuNTI1MTcsLTIuOTg0MzA1IDcuMjQ4NDMsLTIuNDg0OTExIDcuNDQ5NDgs
MC45OTkxODQgMTAuNzg5MTI1LDcuNzUyNzgyIDcuMjMzNjgsMTQuNjI4MjcxIC0wLjgyMjA0LDEu
NTg5NjQ4IC0yLjg3MDY5LDMuMzMwMzM5IC00LjY0OTIyLDMuOTUwMzQgLTQuMDIwMywxLjQwMTQ4
MiAtNC43NzAzNywxLjM1OTgwNyAtOC4xMDYwMiwtMC40NTAzODUgeiIKICAgICBzdHlsZT0iZmls
bDojMDAwMDAwIiAvPgo8L3N2Zz4K
EOF

cat << EOF | base64 --decode > $metadir/dolmades.svg
PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+Cjwh
LS0gQ3JlYXRlZCB3aXRoIElua3NjYXBlIChodHRwOi8vd3d3Lmlua3NjYXBlLm9yZy8pIC0tPgoK
PHN2ZwogICB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iCiAgIHht
bG5zOmNjPSJodHRwOi8vY3JlYXRpdmVjb21tb25zLm9yZy9ucyMiCiAgIHhtbG5zOnJkZj0iaHR0
cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyIKICAgeG1sbnM6c3ZnPSJo
dHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIKICAgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIw
MDAvc3ZnIgogICB4bWxuczpzb2RpcG9kaT0iaHR0cDovL3NvZGlwb2RpLnNvdXJjZWZvcmdlLm5l
dC9EVEQvc29kaXBvZGktMC5kdGQiCiAgIHhtbG5zOmlua3NjYXBlPSJodHRwOi8vd3d3Lmlua3Nj
YXBlLm9yZy9uYW1lc3BhY2VzL2lua3NjYXBlIgogICB2ZXJzaW9uPSIxLjEiCiAgIGlkPSJzdmcy
IgogICB3aWR0aD0iMjRweCIKICAgaGVpZ2h0PSIyNHB4IgogICB2aWV3Qm94PSIwIDAgNTAuODc3
NTYgMjguMDk1NjI1IgogICBzb2RpcG9kaTpkb2NuYW1lPSJpY29uczgtZG9sbWFkZXMtNTIuc3Zn
IgogICBpbmtzY2FwZTp2ZXJzaW9uPSIwLjkyLjMgKDI0MDU1NDYsIDIwMTgtMDMtMTEpIj4KICA8
bWV0YWRhdGEKICAgICBpZD0ibWV0YWRhdGE4Ij4KICAgIDxyZGY6UkRGPgogICAgICA8Y2M6V29y
awogICAgICAgICByZGY6YWJvdXQ9IiI+CiAgICAgICAgPGRjOmZvcm1hdD5pbWFnZS9zdmcreG1s
PC9kYzpmb3JtYXQ+CiAgICAgICAgPGRjOnR5cGUKICAgICAgICAgICByZGY6cmVzb3VyY2U9Imh0
dHA6Ly9wdXJsLm9yZy9kYy9kY21pdHlwZS9TdGlsbEltYWdlIiAvPgogICAgICAgIDxkYzp0aXRs
ZT48L2RjOnRpdGxlPgogICAgICA8L2NjOldvcms+CiAgICA8L3JkZjpSREY+CiAgPC9tZXRhZGF0
YT4KICA8ZGVmcwogICAgIGlkPSJkZWZzNiIgLz4KICA8c29kaXBvZGk6bmFtZWR2aWV3CiAgICAg
cGFnZWNvbG9yPSIjZmZmZmZmIgogICAgIGJvcmRlcmNvbG9yPSIjNjY2NjY2IgogICAgIGJvcmRl
cm9wYWNpdHk9IjEiCiAgICAgb2JqZWN0dG9sZXJhbmNlPSIxMCIKICAgICBncmlkdG9sZXJhbmNl
PSIxMCIKICAgICBndWlkZXRvbGVyYW5jZT0iMTAiCiAgICAgaW5rc2NhcGU6cGFnZW9wYWNpdHk9
IjAiCiAgICAgaW5rc2NhcGU6cGFnZXNoYWRvdz0iMiIKICAgICBpbmtzY2FwZTp3aW5kb3ctd2lk
dGg9IjEzNjYiCiAgICAgaW5rc2NhcGU6d2luZG93LWhlaWdodD0iNzE0IgogICAgIGlkPSJuYW1l
ZHZpZXc0IgogICAgIHNob3dncmlkPSJmYWxzZSIKICAgICBpbmtzY2FwZTp6b29tPSI0LjUzODQ2
MTUiCiAgICAgaW5rc2NhcGU6Y3g9IjU4LjYxMDE3MSIKICAgICBpbmtzY2FwZTpjeT0iMy44NjQ1
NTE5IgogICAgIGlua3NjYXBlOndpbmRvdy14PSIwIgogICAgIGlua3NjYXBlOndpbmRvdy15PSIw
IgogICAgIGlua3NjYXBlOndpbmRvdy1tYXhpbWl6ZWQ9IjEiCiAgICAgaW5rc2NhcGU6Y3VycmVu
dC1sYXllcj0ic3ZnMiIKICAgICBmaXQtbWFyZ2luLXRvcD0iMCIKICAgICBmaXQtbWFyZ2luLWxl
ZnQ9IjAiCiAgICAgZml0LW1hcmdpbi1yaWdodD0iMCIKICAgICBmaXQtbWFyZ2luLWJvdHRvbT0i
MCIgLz4KICA8cGF0aAogICAgIHN0eWxlPSJmaWxsOiMwMDAwMDAiCiAgICAgZD0iTSAxLjc1LDI3
LjAzOTQ1MiBDIC0wLjk3MjQ3OSwyNS40MTYzMDcgLTAuMzI3NDU2LDIxLjU0MTc3NyAzLjUsMTYu
NTI3NTM3IDUuNDI1LDE0LjAwNTY1IDcsMTEuNTI2NzU2IDcsMTEuMDE4ODg0IGMgMCwtMS44MDgx
OTQ4IDEuNjk3MDA3LC0wLjg4MzgxNyAyLjc5Mjg0ODQsMS41MjEyOTMgMC45NjQ0MzU2LDIuMTE2
NzA4IDEuNTg5NzA3NiwyLjM2NzQ4MSA0LjY2MDUxNDYsMS44NjkxNTggNC4yMDIwNzcsLTAuNjgx
OTAzIDQuNDAwNTk2LDAuMzEwNzQxIDEuNjM3MTQ4LDguMTg2MTQ1IGwgLTEuNzU0NDgsNSAtNS40
MTgwMTUsMC4yNDM2NjIgQyA1LjkzODEwNywyNy45NzMxNTYgMi43MTI1LDI3LjYxMzI5NiAxLjc1
LDI3LjAzOTQ1MiBaIG0gMTQuMjQ5OTk5LDAuNTQwOTMgYyAwLC0xLjc3ODI3MiAzLjQ1NTIxMywt
MTIuNDg0OTAyIDQuMDI5MDkyLC0xMi40ODQ5MDIgMC4zODU2NTUsMCAxLjg2ODU5NiwwLjkxODI4
MSAzLjI5NTQyNSwyLjA0MDYyNSBsIDIuNTk0MjM0LDIuMDQwNjI0IDIuMDQwNjI0LC0yLjA0MDYy
NCBjIDEuMTIyMzQ0LC0xLjEyMjM0NCAyLjM3ODEyNSwtMi4wMzY3NzggMi43OTA2MjUsLTIuMDMy
MDc3IDAuNjc3MzY1LDAuMDA3NyA0LjMxMjc0NSwxMC40MzM3MiA0LjI2ODM5OSwxMi4yNDE0NTIg
LTAuMDIwMjksMC44MjcyNzYgLTE5LjAxODM5OSwxLjA2MTkyNyAtMTkuMDE4Mzk5LDAuMjM0OTAy
IHogbSAyMS4xMzU4MywtMC44MjEyMzYgYyAtMS4zMzgyMDgsLTEuNjEyNDQyIC00LjEzNTgzLC05
LjMyNTc2MyAtNC4xMzU4MywtMTEuNDAyODkyIDAsLTEuMTE0OTAzIDAuODE0NTIzLC0xLjM2MTg1
OSAzLjI1LC0wLjk4NTM2OSAyLjYwNTAyNiwwLjQwMjcgMy42NTQ1MzEsMC4wMDc4IDUuMjg4NDE1
LC0xLjk5MDAyNyBsIDIuMDM4NDE1LC0yLjQ5MjQzMDggMy43MTE1ODUsNi4yNTMyOTM4IGMgNC4x
ODY4MjgsNy4wNTM5ODYgNC41NzI0MDcsOS40MjI2OTQgMS43NzczMjYsMTAuOTE4NTc1IC0yLjc2
OTgwOCwxLjQ4MjM1NyAtMTAuNjE0MDY5LDEuMjg0MzQxIC0xMS45Mjk5MTEsLTAuMzAxMTUgeiBN
IDQ3Ljc0OTk5OSwxNC45MTc0MSBjIC0xLjUxMjUsLTIuNTcyOTM4IC0yLjc1LC01LjE3MDA4NTgg
LTIuNzUsLTUuNzcxNDM4OCAwLC0xLjI0OTc1NTIgNC43MjY4OSwtMy42NTY5MzQyIDUuNTU0OTUz
LC0yLjgyODg3MTIgMC4zMDA1NzUsMC4zMDA1NzUgMC40MTExNzQsMy40MTExNzMyIDAuMjQ1Nzc0
LDYuOTEyNDQgbCAtMC4zMDA3MjcsNi4zNjU5NCB6IE0gMCwxMS43NDI2NzYgViA1LjE0NDk4MiBM
IDIuNjQ0MDc1LDYuMTUwMjU3IEMgNC4wOTgzMTcsNi43MDMxNTkgNS42Njk5NjksNy4zOTE1MSA2
LjEzNjYzNiw3LjY3OTkyNiA3LjE1MzcyMiw4LjMwODUyMDIgMy43OTczMTQsMTUuMTg4ODc5IDEu
NTczMDg4LDE3LjAzNDgyMiAwLjE2OTMzOCwxOC4xOTk4MzIgMCwxNy42MzAxNDkgMCwxMS43NDI2
NzYgWiBtIDIwLjExODQ5NiwwLjcxNDcwMyBjIC0xLjg1OTgyNiwtMC44MTEyMjMgLTMuOTk3MzI2
LC0xLjIzODYzOCAtNC43NSwtMC45NDk4MSAtMS44MzQ5MzEsMC43MDQxMjkgLTEuNzgzNjUyLDAu
NDc4NzA0IDEuMzM5ODIxLC01Ljg4OTkzNSAyLjU3NDM5NywtNS4yNDkwOTUgMi44OTU4MDgsLTUu
NTIyMTU0IDYuNSwtNS41MjIxNTQgMi4wODU0MjUsMCAzLjc5MTY4MiwwLjMwMDYzOSAzLjc5MTY4
MiwwLjY2ODA4NyAwLDIuNDk5MDE2IC0yLjMyODg1NCwxMy4zMTYzNDUgLTIuODUyNjU1LDEzLjI1
MDMzOSAtMC4zNTYwNCwtMC4wNDQ4NyAtMi4xNjkwMjEsLTAuNzQ1MzAzIC00LjAyODg0OCwtMS41
NTY1MjcgeiBNIDI2LjYyOTkwNSw5Ljk2NDI5NDIgQyAyOC4wMjIxOTYsMS4xNjg0NjIgMjguMzM5
MTg3LDAuNjIwMzYyIDMyLjIyNDY1NCwwLjI5MDU3MSBjIDMuMzAxMDYzLC0wLjI4MDE4OSAzLjY0
MDI3MiwtMC4wNTcyMyA0LjE4MzgzLDIuNzUgMC4zMjUzMzMsMS42ODAyIDAuODY3MTA4LDQuNDcy
NDY4IDEuMjAzOTQ1LDYuMjA1MDQxMiAwLjUwMTcxLDIuNTgwNjI1OCAwLjMzMTI4LDMuMDQyMjQ0
OCAtMC45NDI3MDEsMi41NTMzNzI4IC0xLjQ1MTk3MywtMC41NTcxNzUgLTQuNzcxMjg3LDAuMTE0
NDk1IC04Ljk1MDU0NiwxLjgxMTE2MSAtMS42MDIyMzUsMC42NTA0NjMgLTEuNzExNDY5LDAuMjg0
ODU2IC0xLjA4OTI3NywtMy42NDU4NTE4IHogTSA5LjMxNTAzMSw3LjUzMjkxNCBDIDcuNTYzMjk5
LDUuNzQ1NDM4IDQuNzAxMDUxLDMuOTY5MDk0IDIuOTU0NDgyLDMuNTg1NDgzIDAuMTg5MTQ5LDIu
OTc4MTE0IC0wLjAzNDg5MSwyLjcwMTc5OSAxLjIyMDI3NCwxLjQ0NjYzNCAyLjI4MTAyNywwLjM4
NTg4MSA0LjY1OTY2NiwwLjA4MzE5IDEwLjIyNzk0NywwLjMwMDM3IGwgNy41NjYzMDEsMC4yOTUx
MSAtMi42NDcxMjUsNS4wOTM2OTUgLTIuNjQ3MTI0LDUuMDkzNjk2IHogTSAzOC42NzE4NjUsOC40
Mzk0MzkyIEMgMzguMzg0NDYxLDcuNDI1MjYyIDM3Ljg1MDI0NCw1LjExMTQ5NyAzNy40ODQ3MTUs
My4yOTc3NCBMIDM2LjgyMDExNywwIDQzLjU4MDM2MSwwLjI5Nzc0IGMgNy41MTAyOTIsMC4zMzA3
NzQgOS4zNDIwMjgsMS45MzE5NDEgNC4yNDM0NTcsMy43MDkzMTIgLTEuNzk2ODg5LDAuNjI2Mzk5
IC00LjQ3MzU5NSwyLjI5NDgzMSAtNS45NDgyMzUsMy43MDc2MjcgLTIuNDU3ODU3LDIuMzU0Nzc1
IC0yLjcyNDY4OCwyLjQxNTEzOSAtMy4yMDM3MTgsMC43MjQ3NjAyIHoiCiAgICAgaWQ9InBhdGg0
NTkzIgogICAgIGlua3NjYXBlOmNvbm5lY3Rvci1jdXJ2YXR1cmU9IjAiIC8+Cjwvc3ZnPgo=
EOF

cat << EOF > $metadir/dolmades.png
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
7uwAAAAASUVORK5CYII=
EOF

createIcons


# create a FIFO file, used to manage the I/O redirection from shell
PIPE=$(mktemp -u --tmpdir ${0##*/}.XXXXXXXX)
mkfifo $PIPE

# attach a file descriptor to the file
exec 3<> $PIPE

# add handler for tray icon left click
function on_click() {
    yad --sticky --on-top --center --form --text="Please select a target to run for $dolmadeName!" --button=gtk-ok --auto-close --kill-parent --image="$dolmadeIcon"
}

function on_click2() {
    yad --sticky --on-top --width=600 --height=400 --center --form --field="$dolmadeName is running $1:TXT" "$(cat $metadir/run.log)" --button=gtk-ok --auto-close --kill-parent --image="$dolmadeIcon"
}

export -f on_click
export -f on_click2
export dolmadeName
export dolmadeIcon
export metadir

# install a notification icon for the duration of the run
yad --notification --image="$metadir/dolmades.png" --listen \
    --text "Dolmade Target Selector has been started" \
    --no-middle \
    --command="bash -c on_click" \
    <&3 &
# add handler to manage process shutdown
function on_exit() {
    echo "quit" >&3
    rm -f $PIPE
}
trap on_exit EXIT

selection=$(yad --sticky --on-top --title="$dolmadeName" --image="$dolmadeIcon" --button=gtk-ok:0 --button=gtk-cancel:1 --form --separator="$separator" --item-separator="$separator" --field="Select Target":CB "${lnkTargets%$separator}")
if [ "$?" == 0 ]; then
        selection="${selection%$separator}"
	selectionstr="$(echo $selection|sed 's/\\/\\\\/g')"
        export selectionstr
	echo "Running $selection..."

	echo "icon:$metadir/run.svg" >&3
        echo "tooltip:$selectionstr is running..." >&3
        selectionstr="$(echo $selectionstr|sed 's/\\/\\\\/g')"
        echo "action:bash -c 'on_click2 \"$selectionstr\"'" >&3
        echo 'menu:Kill it!wineserver --kill!'$metadir'/cancel.svg' >&3
	
        wine start "$selection" &> "$metadir/run.log"

        # and wait until wineserver has stopped all processes and is shut down
	wineserver -w
	echo "icon:$metadir/cancel.svg" >&3
	echo "tooltip:Shutting down $dolmadeName..." >&3

        j=600
	for ((i=1; i<=100; i++))
	{
		j=$(($j - 5))
		echo $i
		echo "# Closing this window in ${j::-2} seconds"
		sleep 0.05
	} | yad --sticky --on-top --progress --button=gtk-ok --image="$dolmadeIcon" --title="$dolmadeName" --center --text="Wine has terminated!" --auto-close --kill-parent
else
	echo "Cancelled..."
fi
